---
layout: post
category: 科研
title: 喉镜图像处理
tags: 喉镜
---



- 图像去马赛克
- 该款CMOS是基于Bayer模式彩色阵列,色彩模式为BG/GR阵列,一共输出656*488个像素点,对于640*480的图像其佘的像素点用来边界的插值和黑点校正。
- 去马赛克方法，领域复制算法，最接近的4个像素中的一个进行插值，双线性插值算法是基于周围的四个像素值的平均值插值。，没有利用色彩的分量，容易出现虚假色和锯齿现象，速度比较快。
- **色比恒定算法：**假设在图像中一个足够小的区域内图像是平滑的，即色彩的亮度也是均匀变化的算法利用彩色图像分量之间的信息。
- 基于均方差的通道差方向滤波器法
- 基于边界的自适应算法


----
- CMOS的曝光可以设置为自动曝光和手动曙光,芯片内部的**ISP**具有自动曝光的功能,ISP内部有**AGC(自动增益曝光),AEC(自动时间曝光)**。寄存器0x13的Bit[0]和Bit[2]是AGC、AEC的使能位。使能AGC后发现图像质量变差,自动增益会引进很多的噪声,因此设定增益模式为手动,**通过调整曝光时间来控制图片的亮度**。
- CMOS内部AEC的算法是计算整个图片的**亮度平均值**,根据设定平均值的最大值和最小值调整亮度,根据测试发现,使能AEC后,图像有自动曝光的功能,但是速度很慢,需要3-4秒才能得到一副清晰的图像,对于手术操作而言,这个**速度太慢**
- CMOS的自动曝光时间设置为手动调整后,曝光时间设置有两个字节，曝光的范围为0-65535,ARM芯片计算速度很快,可以达到IGhz,通过计算图像的亮度平均值,然后调整曙光时间实现自动曝光。
- 测光方式：峰值测光和均值测光
- **峰值测光：**亮度的调整是根据中心最亮的区域来调整曙光时间,具体的原理是把釆集到的一幅320*240的图像分为16个80*60的区域,计算每个区域的平均亮度,对这16个亮度平均值进行排序,得到最大的亮度值,如果这个亮度大于200,则减小曝光时间,如果这个亮度值小于80,则增加曝光时间。为了增快自动曝光的速度,在刚开始调整曝光时间时,每次增加50,随着亮度值的增大,
曝光时间每次增加10,这样可以保证速度同时获得比较好的亮度。调整OV7740的曝光时间是通过向串口发送命令,单片机在接收到命令后,配置CMOS的曝光时间寄存器。如果设定的阈值不合适,会出现忽明忽暗的情况,因此需要根据视频喉镜工作环境和照明的光源,调整合适的阈值。
- **均值测光：**计算一整幅图像的平均亮度值,如果这个亮度值大于120,则减小曝光时间,如果这个亮度值小于90,则增加曝光时间,增减或减少曙光时间可以通过nC协议设置OV7740的曝光寄存器。

-----
- 不同的光源具有的不同的光谱成分和分布称为色差
- 白平衡算法有灰度世界算法、白色块算法
- **灰度世界算法**认为在足够多的彩色图片下,标准光源下R、G、B通道的平均值应该等于一个常数33,计算整个图像的RGB平均值,根据这个平均值确定RGB通道的增益,然后对图像进行调整。
- **基于色温估计的自动白平衡算法:**首先统计不同色温的Cr. Cb分布规律,根据图像中的Cr/Cb值计算色温,通过色温对图像进行调整
- **白色块算法**是假设图像中最亮的点是白点计算出图像中最亮的点R、G、B三通道的值,白色点的RGB值为255,根据这个计算出三通道的增益然后调整图像

------
- 图像处理流水线主要包括三个部分：图像传感器接口通道（sensor interface engine）、图像处理通道（image processing Engine）、图像操作通道（image manipulation）。
- 图像传感器接口通道部分主要包括：镜头校正、坏点补偿、颜色校正、伽马校正。
- 自动曝光算法分三个步骤：测光、曝光参数估计、曝光校正。
- `CFA颜色滤波阵列`最为常见的是Bayer模式
- CFA有很多的插值方法，包括线性插值、三次插值、自适应差值法
- 白平衡算法：简单的有白色块算法、灰度世界算法、边沿灰度世界算法。复杂的有颜色相关性算法、神经网络算法、色域映射算法。

-----

目前大多数数码相机中的自动白平衡算法都是采用基于色温估计的白平衡调
节，一般基于色温估计的自动白平衡调节都是依据相机的PREVIE模式的前一帧
图像的信息来判断当前帧图像的白平衡信息。一般PREVIE模式下跑一帧图像只
需要1/25s,而白平衡只需跑3帧图像即可达到稳定的状态，在3*1/25s 
的时间间隔内，现实生活中无法做到光源的突然转换，所以这种方法被广泛应用。

------

可以基于固定的色温、光线环境。因为所配的LED灯是确定的。





